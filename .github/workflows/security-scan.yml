name: üîí Security Scan with NVD Cache

on:
  push:
    branches: 
      - feature/dependecy-check
  pull_request:
    branches:
      - feature/dependecy-check
  workflow_dispatch:
    inputs:
      skip-cache:
        description: 'Ignorar cache e baixar NVD do zero'
        required: false
        default: false
        type: boolean

jobs:
  dependency-check:
    name: üîç OWASP Dependency Check
    runs-on: ubuntu-latest
    environment: STG
    
    permissions:
      contents: read
      security-events: write  # Para SARIF upload
    
    steps:
      - name: üì• Checkout c√≥digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: üêç Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: üì¶ Instalar depend√™ncias Python
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
            echo "‚úÖ Depend√™ncias instaladas"
          else
            echo "‚ö†Ô∏è requirements.txt n√£o encontrado"
          fi
      
      - name: üì• Carregar Cache NVD da branch gh-pages
        if: github.event.inputs.skip-cache != 'true'
        id: load-cache
        run: |
          echo "üîç Verificando cache na branch gh-pages..."
          
          # Verificar se branch gh-pages existe
          if git ls-remote --exit-code --heads origin gh-pages > /dev/null 2>&1; then
            echo "‚úÖ Branch gh-pages encontrada"
            
            # Fetch apenas o cache
            git fetch origin gh-pages --depth=1
            
            # Tentar fazer checkout do diret√≥rio nvd_cache
            if git checkout origin/gh-pages -- nvd_cache/ 2>/dev/null; then
              if [ -d "nvd_cache" ] && [ "$(find nvd_cache -type f | wc -l)" -gt 5 ]; then
                echo "üì¶ Cache encontrado! Copiando para diret√≥rio do Dependency-Check..."
                
                mkdir -p $HOME/OWASP-Dependency-Check/data
                cp -r nvd_cache/* $HOME/OWASP-Dependency-Check/data/
                
                CACHE_SIZE=$(du -sh $HOME/OWASP-Dependency-Check/data | cut -f1)
                FILE_COUNT=$(find $HOME/OWASP-Dependency-Check/data -type f | wc -l)
                
                echo "cache-loaded=true" >> $GITHUB_OUTPUT
                echo "cache-size=$CACHE_SIZE" >> $GITHUB_OUTPUT
                echo "cache-files=$FILE_COUNT" >> $GITHUB_OUTPUT
                
                echo "‚úÖ Cache carregado com sucesso!"
                echo "   - Tamanho: $CACHE_SIZE"
                echo "   - Arquivos: $FILE_COUNT"
                
                if [ -f "$HOME/OWASP-Dependency-Check/data/cache.properties" ]; then
                  echo "   - Data do cache:"
                  grep "lastModified" $HOME/OWASP-Dependency-Check/data/cache.properties | head -3 || true
                fi
              else
                echo "cache-loaded=false" >> $GITHUB_OUTPUT
                echo "‚ö†Ô∏è Cache vazio ou inv√°lido"
              fi
            else
              echo "cache-loaded=false" >> $GITHUB_OUTPUT
              echo "‚ö†Ô∏è Diret√≥rio nvd_cache n√£o encontrado na branch gh-pages"
            fi
          else
            echo "cache-loaded=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Branch gh-pages n√£o existe"
            echo ""
            echo "üí° Para criar o cache:"
            echo "   1. V√° em Actions ‚Üí Update NVD Cache"
            echo "   2. Clique em 'Run workflow'"
            echo "   3. Aguarde a conclus√£o (10-15 minutos)"
          fi
          
          if [ "${{ steps.load-cache.outputs.cache-loaded }}" != "true" ]; then
            echo ""
            echo "‚ö†Ô∏è Executando sem cache (ser√° mais lento)"
          fi
      
      - name: üîí OWASP Dependency Check
        uses: ./.github/actions/dependency-check
        id: depcheck
        with:
          nvd-api-key: ${{ secrets.NVD_API_KEY }}
          project: ${{ github.event.repository.name }}
          scan-path: '.'
          output-formats: 'HTML,JSON,XML,SARIF'
          fail-on-cvss: '7'
          fail-on-error: 'false'
      
      - name: üìä An√°lise Detalhada de Vulnerabilidades
        if: always()
        shell: bash
        run: |
          echo "### üìä Security Scan Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Informa√ß√µes do cache
          if [ "${{ steps.load-cache.outputs.cache-loaded }}" == "true" ]; then
            echo "**üì¶ Cache NVD:** ‚úÖ Usado (Tamanho: ${{ steps.load-cache.outputs.cache-size }}, Arquivos: ${{ steps.load-cache.outputs.cache-files }})" >> $GITHUB_STEP_SUMMARY
          else
            echo "**üì¶ Cache NVD:** ‚ö†Ô∏è N√£o usado (dados baixados durante o scan)" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f ".odc-reports/dependency-check-report.json" ]; then
            # Extrair estat√≠sticas
            TOTAL_DEPS=$(jq '.dependencies | length' .odc-reports/dependency-check-report.json 2>/dev/null || echo "0")
            CRITICAL=$(jq '[.dependencies[]?.vulnerabilities[]? | select(.severity=="CRITICAL")] | length' .odc-reports/dependency-check-report.json 2>/dev/null || echo "0")
            HIGH=$(jq '[.dependencies[]?.vulnerabilities[]? | select(.severity=="HIGH")] | length' .odc-reports/dependency-check-report.json 2>/dev/null || echo "0")
            MEDIUM=$(jq '[.dependencies[]?.vulnerabilities[]? | select(.severity=="MEDIUM")] | length' .odc-reports/dependency-check-report.json 2>/dev/null || echo "0")
            LOW=$(jq '[.dependencies[]?.vulnerabilities[]? | select(.severity=="LOW")] | length' .odc-reports/dependency-check-report.json 2>/dev/null || echo "0")
            TOTAL_VULNS=$((CRITICAL + HIGH + MEDIUM + LOW))
            
            echo "#### üìà Resumo de Vulnerabilidades" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Severidade | Quantidade |" >> $GITHUB_STEP_SUMMARY
            echo "|-----------|------------|" >> $GITHUB_STEP_SUMMARY
            echo "| üì¶ **Total de Depend√™ncias** | **$TOTAL_DEPS** |" >> $GITHUB_STEP_SUMMARY
            echo "| üî¥ **Cr√≠ticas (CVSS ‚â• 9.0)** | **$CRITICAL** |" >> $GITHUB_STEP_SUMMARY
            echo "| üü† **Altas (CVSS 7.0-8.9)** | **$HIGH** |" >> $GITHUB_STEP_SUMMARY
            echo "| üü° M√©dias (CVSS 4.0-6.9) | $MEDIUM |" >> $GITHUB_STEP_SUMMARY
            echo "| üü¢ Baixas (CVSS < 4.0) | $LOW |" >> $GITHUB_STEP_SUMMARY
            echo "| üìä **Total de Vulnerabilidades** | **$TOTAL_VULNS** |" >> $GITHUB_STEP_SUMMARY
            
            # Alertas para vulnerabilidades cr√≠ticas
            if [ "$CRITICAL" -gt 0 ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### üö® ALERTA: Vulnerabilidades Cr√≠ticas!" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "Foram encontradas **$CRITICAL vulnerabilidade(s) CR√çTICA(S)** (CVSS ‚â• 9.0)!" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**A√ß√£o requerida:** Revise e corrija imediatamente." >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              
              # Listar CVEs cr√≠ticos (top 5)
              echo "#### Top 5 CVEs Cr√≠ticos:" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              jq -r '.dependencies[]?.vulnerabilities[]? | select(.severity=="CRITICAL") | "- **\(.name)** - CVSS: \(.cvssv3?.baseScore // .cvssv2?.score // "N/A") - \(.description[0:100])..."' .odc-reports/dependency-check-report.json 2>/dev/null | head -5 >> $GITHUB_STEP_SUMMARY || true
            elif [ "$HIGH" -gt 0 ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### ‚ö†Ô∏è Aten√ß√£o: Vulnerabilidades Altas" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "Foram encontradas **$HIGH vulnerabilidade(s) ALTA(S)** (CVSS 7.0-8.9)." >> $GITHUB_STEP_SUMMARY
              echo "Recomenda-se revisar e corrigir quando poss√≠vel." >> $GITHUB_STEP_SUMMARY
            else
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### ‚úÖ Nenhuma Vulnerabilidade Cr√≠tica ou Alta!" >> $GITHUB_STEP_SUMMARY
            fi
            
            # Listar depend√™ncias mais vulner√°veis
            if [ "$TOTAL_VULNS" -gt 0 ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "#### üì¶ Top 5 Depend√™ncias Mais Vulner√°veis:" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              jq -r '.dependencies[] | select(.vulnerabilities) | "\(.fileName): \(.vulnerabilities | length) vuln(s)"' .odc-reports/dependency-check-report.json 2>/dev/null | sort -t: -k2 -rn | head -5 | sed 's/^/- /' >> $GITHUB_STEP_SUMMARY || true
            fi
          else
            echo "‚ö†Ô∏è **Status:** Relat√≥rio JSON n√£o encontrado" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "üìÑ **Relat√≥rios completos dispon√≠veis nos Artifacts**" >> $GITHUB_STEP_SUMMARY
      
      # Upload para GitHub Security (SARIF)
      - name: üîê Upload SARIF para GitHub Security
        if: always() && hashFiles('.odc-reports/dependency-check-report.sarif') != ''
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: .odc-reports/dependency-check-report.sarif
          category: dependency-check
        continue-on-error: true
      
      - name: üì§ Upload Relat√≥rios
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: dependency-check-reports-${{ github.run_number }}
          path: .odc-reports/
          retention-days: 30
      
      - name: ‚ùå Verificar e Falhar em Vulnerabilidades Cr√≠ticas
        if: always()
        shell: bash
        run: |
          if [ -f ".odc-reports/dependency-check-report.json" ]; then
            CRITICAL=$(jq '[.dependencies[]?.vulnerabilities[]? | select(.severity=="CRITICAL")] | length' .odc-reports/dependency-check-report.json 2>/dev/null || echo "0")
            
            if [ "$CRITICAL" -gt 0 ]; then
              echo "‚ùå FALHA: $CRITICAL vulnerabilidade(s) CR√çTICA(S) encontrada(s)!"
              echo "Pipeline configurado para alertar, mas n√£o falhar."
              echo "Para falhar o pipeline, altere 'fail-on-error' para 'true'"
              # Descomente para FALHAR o pipeline:
              # exit 1
            else
              echo "‚úÖ Nenhuma vulnerabilidade cr√≠tica encontrada"
            fi
          fi