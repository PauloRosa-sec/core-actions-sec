name: ðŸ”„ Update NVD Cache

on:
  #schedule:
    # Executa todo dia Ã s 11:00 UTC (8:00 AM BrasÃ­lia)
   # - cron: '0 11 * * *'
  push:
    branches: 
            - feature/dependecy-check
  pull_request:
    branches:
      - feature/dependecy-check
  workflow_dispatch:  # Permite execuÃ§Ã£o manual
    inputs:
      force-update:
        description: 'ForÃ§ar atualizaÃ§Ã£o completa (ignorar cache existente)'
        required: false
        default: false
        type: boolean

jobs:
  update-nvd-cache:
    name: ðŸ“¦ Atualizar Cache NVD1
    runs-on: ubuntu-latest
    environment: STG
    permissions:
      contents: write
    
    steps:
      - name: ðŸ“¥ Checkout branch gh-pages
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          ref: gh-pages
        continue-on-error: true  # Se gh-pages nÃ£o existe, continua
      
      - name: ðŸ”§ Criar branch gh-pages se nÃ£o existir
        run: |
          if ! git show-ref --verify --quiet refs/heads/gh-pages; then
            echo "âš ï¸ Branch gh-pages nÃ£o existe. Criando..."
            git checkout --orphan gh-pages
            git rm -rf . 2>/dev/null || true
            echo "# NVD Cache Storage" > README.md
            echo "Este branch armazena o cache do NVD Database para acelerar scans de seguranÃ§a." >> README.md
            echo "" >> README.md
            echo "**NÃ£o modifique manualmente!** Este conteÃºdo Ã© gerenciado automaticamente." >> README.md
            git add README.md
            git config user.email "actions@github.com"
            git config user.name "GitHub Actions"
            git commit -m "chore: inicializar branch gh-pages"
            git push origin gh-pages
            echo "âœ… Branch gh-pages criada"
          else
            echo "âœ… Branch gh-pages jÃ¡ existe"
          fi
      
      - name: â˜• Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
      
      - name: ðŸ” Verificar cache existente
        id: check-cache
        run: |
          if [ -d "nvd_cache" ] && [ "$(find nvd_cache -type f | wc -l)" -gt 5 ]; then
            echo "cache-exists=true" >> $GITHUB_OUTPUT
            CACHE_SIZE=$(du -sh nvd_cache | cut -f1)
            FILE_COUNT=$(find nvd_cache -type f | wc -l)
            echo "âœ… Cache existente encontrado:"
            echo "   - Tamanho: $CACHE_SIZE"
            echo "   - Arquivos: $FILE_COUNT"
            
            if [ -f "nvd_cache/cache.properties" ]; then
              echo "   - Ãšltima atualizaÃ§Ã£o:"
              grep "lastModified" nvd_cache/cache.properties | head -3 || true
            fi
          else
            echo "cache-exists=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ Cache nÃ£o encontrado ou vazio"
          fi
      
      - name: ðŸ”„ Atualizar Cache NVD
        env:
          NVD_API_KEY: ${{ secrets.NVD_API_KEY }}
        run: |
          echo "ðŸ“¥ Baixando ferramenta vulnz (Open Vulnerability CLI)..."
          curl -sL https://github.com/jeremylong/open-vulnerability-cli/releases/download/v9.0.0/vulnz-9.0.0.jar -o vulnz.jar
          
          if [ "${{ github.event.inputs.force-update }}" == "true" ]; then
            echo "ðŸ—‘ï¸ Removendo cache antigo (force update)..."
            rm -rf nvd_cache
          fi
          
          if [ "${{ steps.check-cache.outputs.cache-exists }}" == "true" ] && [ "${{ github.event.inputs.force-update }}" != "true" ]; then
            echo "ðŸ”„ Atualizando cache existente..."
            git reset --soft HEAD~1 || true
          else
            echo "ðŸ“¦ Criando cache do zero..."
            mkdir -p nvd_cache
          fi
          
          echo ""
          echo "â³ Baixando dados do NVD (isso pode levar 10-15 minutos)..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          java -jar vulnz.jar cve \
            --cache \
            --directory ./nvd_cache \
            --requestCount=30 \
            --debug \
            --delay=8000 \
            --maxRetry=40 || {
              echo "âŒ Erro ao baixar dados do NVD"
              echo "Verifique se a NVD_API_KEY estÃ¡ configurada corretamente"
              exit 1
            }
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Download concluÃ­do!"
          echo ""
          
          rm -f vulnz.jar
          
          echo "ðŸ“Š InformaÃ§Ãµes do cache:"
          CACHE_SIZE=$(du -sh ./nvd_cache | cut -f1)
          FILE_COUNT=$(find ./nvd_cache -type f | wc -l)
          echo "   - Tamanho: $CACHE_SIZE"
          echo "   - Arquivos: $FILE_COUNT"
          
          if [ -f "nvd_cache/cache.properties" ]; then
            echo ""
            echo "ðŸ“‹ Propriedades do cache:"
            cat nvd_cache/cache.properties
          fi
      
      - name: ðŸ“¤ Commit e Push do cache
        run: |
          git config user.email "actions@github.com"
          git config user.name "GitHub Actions"
          
          git add nvd_cache/
          git add README.md || true
          
          if git diff --staged --quiet; then
            echo "â„¹ï¸ Nenhuma mudanÃ§a detectada no cache"
            echo "O cache jÃ¡ estÃ¡ atualizado"
          else
            COMMIT_MSG="chore: atualizar cache NVD - $(date +'%Y-%m-%d %H:%M UTC')"
            
            if [ "${{ github.event.inputs.force-update }}" == "true" ]; then
              COMMIT_MSG="$COMMIT_MSG (force update)"
            fi
            
            git commit -m "$COMMIT_MSG"
            git push origin gh-pages --force
            echo "âœ… Cache atualizado e publicado com sucesso!"
          fi
      
      - name: ðŸ“Š Resumo da AtualizaÃ§Ã£o
        if: always()
        run: |
          echo "### ðŸ“¦ AtualizaÃ§Ã£o do Cache NVD" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Data:** $(date +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -d "nvd_cache" ]; then
            CACHE_SIZE=$(du -sh nvd_cache | cut -f1)
            FILE_COUNT=$(find nvd_cache -type f | wc -l)
            
            echo "| MÃ©trica | Valor |" >> $GITHUB_STEP_SUMMARY
            echo "|---------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸ“¦ Tamanho do Cache | $CACHE_SIZE |" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸ“‚ Total de Arquivos | $FILE_COUNT |" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸŒ¿ Branch | gh-pages |" >> $GITHUB_STEP_SUMMARY
            echo "| âš¡ Status | âœ… Atualizado |" >> $GITHUB_STEP_SUMMARY
            
            if [ -f "nvd_cache/cache.properties" ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**Ãšltima modificaÃ§Ã£o:**" >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
              grep "lastModified" nvd_cache/cache.properties | head -5 >> $GITHUB_STEP_SUMMARY || true
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âŒ **Status:** Falha ao criar cache" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Este cache Ã© usado automaticamente pelos workflows de security scan*" >> $GITHUB_STEP_SUMMARY