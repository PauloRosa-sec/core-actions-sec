name: üîí Security Scan with Dependency-Check
on:
  push:
    branches: 
      - feature/dependecy-check
  pull_request:
    branches:
      - feature/dependecy-check
  workflow_dispatch:  # Permite execu√ß√£o manual agora

jobs:
  dependency-check-scan:
    runs-on: ubuntu-latest
    name: üîç Dependency Check Scan
    environment: STG  # ‚Üê Seu environment com a NVD_API_KEY
    
    steps:
      - name: üì• Checkout c√≥digo
        uses: actions/checkout@v4
      
      # Se seu projeto precisar de build (Maven, Gradle, npm, etc)
      # Descomente e adapte conforme necess√°rio:
      
      # Para Java/Maven:
      # - name: ‚òï Setup Java
      #   uses: actions/setup-java@v4
      #   with:
      #     java-version: '17'
      #     distribution: 'temurin'
      
      # - name: üî® Build com Maven
      #   run: mvn clean install -DskipTests
      
      # Para Node.js:
      # - name: üü¢ Setup Node.js
      #   uses: actions/setup-node@v4
      #   with:
      #     node-version: '18'
      
      # - name: üì¶ Install dependencies
      #   run: npm ci
      
      # Para Python (seu caso):
      - name: üêç Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: üì¶ Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi
      
      # Executar sua custom action
      - name: üîí OWASP Dependency Check
        uses: ./.github/actions/dependency-check
        id: depcheck
        with:
          nvd-api-key: ${{ secrets.NVD_API_KEY }}
          project: ${{ github.event.repository.name }}
          scan-path: '.'
          output-formats: 'HTML,JSON,XML'
          fail-on-cvss: '7'  # Falha se CVSS >= 7
          fail-on-error: 'false'  # N√£o falha o pipeline (apenas alerta)
      
      # An√°lise detalhada dos resultados
      - name: üìä An√°lise de Vulnerabilidades
        if: always()
        shell: bash
        run: |
          echo "### üìä An√°lise Detalhada de Vulnerabilidades" >> $GITHUB_STEP_SUMMARY
          
          if [ -f ".odc-reports/dependency-check-report.json" ]; then
            # Estat√≠sticas
            TOTAL_DEPS=$(jq '.dependencies | length' .odc-reports/dependency-check-report.json 2>/dev/null || echo "0")
            CRITICAL=$(jq '[.dependencies[]?.vulnerabilities[]? | select(.severity=="CRITICAL")] | length' .odc-reports/dependency-check-report.json 2>/dev/null || echo "0")
            HIGH=$(jq '[.dependencies[]?.vulnerabilities[]? | select(.severity=="HIGH")] | length' .odc-reports/dependency-check-report.json 2>/dev/null || echo "0")
            MEDIUM=$(jq '[.dependencies[]?.vulnerabilities[]? | select(.severity=="MEDIUM")] | length' .odc-reports/dependency-check-report.json 2>/dev/null || echo "0")
            LOW=$(jq '[.dependencies[]?.vulnerabilities[]? | select(.severity=="LOW")] | length' .odc-reports/dependency-check-report.json 2>/dev/null || echo "0")
            TOTAL_VULNS=$((CRITICAL + HIGH + MEDIUM + LOW))
            
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "#### üìà Resumo" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| M√©trica | Valor |" >> $GITHUB_STEP_SUMMARY
            echo "|---------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| üì¶ Total de Depend√™ncias | $TOTAL_DEPS |" >> $GITHUB_STEP_SUMMARY
            echo "| üî¥ **Vulnerabilidades Cr√≠ticas** | **$CRITICAL** |" >> $GITHUB_STEP_SUMMARY
            echo "| üü† Vulnerabilidades Altas | $HIGH |" >> $GITHUB_STEP_SUMMARY
            echo "| üü° Vulnerabilidades M√©dias | $MEDIUM |" >> $GITHUB_STEP_SUMMARY
            echo "| üü¢ Vulnerabilidades Baixas | $LOW |" >> $GITHUB_STEP_SUMMARY
            echo "| üìä **Total** | **$TOTAL_VULNS** |" >> $GITHUB_STEP_SUMMARY
            
            # Alerta para vulnerabilidades cr√≠ticas
            if [ "$CRITICAL" -gt 0 ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### ‚ö†Ô∏è ALERTA: Vulnerabilidades Cr√≠ticas Encontradas!" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "Foram encontradas **$CRITICAL vulnerabilidade(s) CR√çTICA(S)**!" >> $GITHUB_STEP_SUMMARY
              echo "Por favor, revise o relat√≥rio detalhado nos artifacts." >> $GITHUB_STEP_SUMMARY
              
              # Listar CVEs cr√≠ticos
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "#### üî¥ CVEs Cr√≠ticos:" >> $GITHUB_STEP_SUMMARY
              jq -r '.dependencies[]?.vulnerabilities[]? | select(.severity=="CRITICAL") | "- **\(.name)** (CVSS: \(.cvssv3?.baseScore // .cvssv2?.score // "N/A")): \(.description // "Sem descri√ß√£o")[0:100]..."' .odc-reports/dependency-check-report.json 2>/dev/null | head -10 >> $GITHUB_STEP_SUMMARY || true
            fi
            
            # Listar depend√™ncias vulner√°veis
            if [ "$TOTAL_VULNS" -gt 0 ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "#### üì¶ Top 5 Depend√™ncias Mais Vulner√°veis:" >> $GITHUB_STEP_SUMMARY
              jq -r '.dependencies[] | select(.vulnerabilities) | "\(.fileName): \(.vulnerabilities | length) vulnerabilidade(s)"' .odc-reports/dependency-check-report.json 2>/dev/null | sort -t: -k2 -rn | head -5 | sed 's/^/- /' >> $GITHUB_STEP_SUMMARY || true
            fi
          else
            echo "‚ö†Ô∏è Relat√≥rio JSON n√£o encontrado" >> $GITHUB_STEP_SUMMARY
          fi
      
      # Upload adicional dos relat√≥rios (al√©m do que j√° est√° na action)
      - name: üì§ Upload Relat√≥rios Dependency-Check
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: dependency-check-reports-${{ github.run_number }}
          path: .odc-reports/
          retention-days: 30
      
      # (Opcional) Falhar se houver vulnerabilidades cr√≠ticas
      - name: ‚ùå Verificar Vulnerabilidades Cr√≠ticas
        if: always()
        shell: bash
        run: |
          if [ -f ".odc-reports/dependency-check-report.json" ]; then
            CRITICAL=$(jq '[.dependencies[]?.vulnerabilities[]? | select(.severity=="CRITICAL")] | length' .odc-reports/dependency-check-report.json 2>/dev/null || echo "0")
            HIGH=$(jq '[.dependencies[]?.vulnerabilities[]? | select(.severity=="HIGH")] | length' .odc-reports/dependency-check-report.json 2>/dev/null || echo "0")
            
            if [ "$CRITICAL" -gt 0 ]; then
              echo "‚ùå FALHA: $CRITICAL vulnerabilidade(s) CR√çTICA(S) encontrada(s)!"
              echo "Por favor, corrija as vulnerabilidades cr√≠ticas antes de prosseguir."
              # Descomente a linha abaixo para FALHAR o pipeline:
              # exit 1
            elif [ "$HIGH" -gt 0 ]; then
              echo "‚ö†Ô∏è AVISO: $HIGH vulnerabilidade(s) ALTA(S) encontrada(s)!"
              echo "Recomenda-se corrigir essas vulnerabilidades."
            else
              echo "‚úÖ Nenhuma vulnerabilidade cr√≠tica ou alta encontrada!"
            fi
          fi