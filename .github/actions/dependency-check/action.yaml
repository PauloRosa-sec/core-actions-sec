name: 'OWASP Dependency-Check (SCA) with Cache'
description: 'Executa anÃ¡lise de dependÃªncias com OWASP Dependency-Check usando cache NVD'
author: 'Security Team'

inputs:
  nvd-api-key:
    description: 'NVD API Key para Dependency-Check'
    required: true
  project:
    description: 'Nome do projeto'
    required: false
    default: 'my-project'
  scan-path:
    description: 'Caminho para scan'
    required: false
    default: '.'
  fail-on-error:
    description: 'Falhar o pipeline em caso de vulnerabilidades crÃ­ticas'
    required: false
    default: 'false'
  output-formats:
    description: 'Formatos de saÃ­da (HTML,JSON,XML,SARIF)'
    required: false
    default: 'HTML,JSON,XML'
  fail-on-cvss:
    description: 'CVSS score mÃ­nimo para falhar (0-10, padrÃ£o: 11 = nunca falha)'
    required: false
    default: '11'

outputs:
  report-path:
    description: 'Caminho do diretÃ³rio com os relatÃ³rios'
    value: ${{ steps.scan.outputs.report-path }}
  vulnerabilities-found:
    description: 'NÃºmero de vulnerabilidades encontradas'
    value: ${{ steps.scan.outputs.vulnerabilities-found }}

runs:
  using: 'composite'
  steps:

  - name: ğŸ“ Criar diretÃ³rios
    shell: bash
    run: |
      mkdir -p .odc-reports
      mkdir -p $HOME/OWASP-Dependency-Check/data
      echo "âœ… DiretÃ³rios criados"

  - name: ğŸ“¦ Verificar Status do Cache NVD
    shell: bash
    id: cache-status
    run: |
      echo "### ğŸ“¦ Status do Cache NVD" >> $GITHUB_STEP_SUMMARY

      if [ -d "$HOME/OWASP-Dependency-Check/data" ]; then
        FILE_COUNT=$(find $HOME/OWASP-Dependency-Check/data -type f 2>/dev/null | wc -l || echo "0")
        
        if [ "$FILE_COUNT" -gt 10 ]; then
          CACHE_SIZE=$(du -sh $HOME/OWASP-Dependency-Check/data 2>/dev/null | cut -f1 || echo "N/A")
          echo "cache-available=true" >> $GITHUB_OUTPUT
          echo "- **Status**: âœ… Cache disponÃ­vel" >> $GITHUB_STEP_SUMMARY
          echo "- **Tamanho**: $CACHE_SIZE" >> $GITHUB_STEP_SUMMARY
          echo "- **Arquivos**: $FILE_COUNT" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "$HOME/OWASP-Dependency-Check/data/cache.properties" ]; then
            echo "- **Ãšltima atualizaÃ§Ã£o**:" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            grep "lastModified" $HOME/OWASP-Dependency-Check/data/cache.properties 2>/dev/null | head -3 >> $GITHUB_STEP_SUMMARY || true
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "cache-available=false" >> $GITHUB_OUTPUT
          echo "- **Status**: âš ï¸ Cache vazio (arquivos: $FILE_COUNT)" >> $GITHUB_STEP_SUMMARY
          echo "- **AÃ§Ã£o**: SerÃ¡ baixado durante o scan" >> $GITHUB_STEP_SUMMARY
        fi
      else
        echo "cache-available=false" >> $GITHUB_OUTPUT
        echo "- **Status**: âš ï¸ Cache nÃ£o encontrado" >> $GITHUB_STEP_SUMMARY
        echo "- **AÃ§Ã£o**: SerÃ¡ baixado durante o scan" >> $GITHUB_STEP_SUMMARY
      fi

  - name: ğŸ” Executar OWASP Dependency-Check
    id: scan
    shell: bash
    run: |
      echo "ğŸ” Iniciando Dependency-Check"
      echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      echo "ğŸ“‚ Projeto: ${{ inputs.project }}"
      echo "ğŸ“‚ Scan path: ${{ inputs.scan-path }}"
      echo "ğŸ“Š Formatos: ${{ inputs.output-formats }}"
      echo "ğŸ“¦ Cache disponÃ­vel: ${{ steps.cache-status.outputs.cache-available }}"
      echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      # Determinar parÃ¢metro NVD
      if [ -z "${{ inputs.nvd-api-key }}" ]; then
        echo "âš ï¸ NVD API Key nÃ£o configurada"
        if [ "${{ steps.cache-status.outputs.cache-available }}" == "true" ]; then
