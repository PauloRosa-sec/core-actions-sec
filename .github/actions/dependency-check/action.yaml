name: 'OWASP Dependency-Check (SCA)'
description: 'Executa anÃ¡lise de dependÃªncias com OWASP Dependency-Check'
author: 'Security Team'

inputs:
  nvd-api-key:
    description: 'NVD API Key para Dependency-Check'
    required: true
  project-name:
    description: 'Nome do projeto'
    required: false
    default: ${{ github.event.repository.name }}
  scan-path:
    description: 'Caminho para scan'
    required: false
    default: '.'
  fail-on-error:
    description: 'Falhar o pipeline em caso de vulnerabilidades crÃ­ticas'
    required: false
    default: 'false'
  output-formats:
    description: 'Formatos de saÃ­da (HTML, JSON, XML)'
    required: false
    default: 'HTML,JSON,XML'

outputs:
  report-path:
    description: 'Caminho do diretÃ³rio com os relatÃ³rios'
    value: ${{ steps.scan.outputs.report-path }}

runs:
  using: 'composite'
  steps:
  - name: Criar diretÃ³rios necessÃ¡rios
    shell: bash
    run: |
      mkdir -p .odc-reports
      mkdir -p $HOME/OWASP-Dependency-Check/data
      mkdir -p $HOME/OWASP-Dependency-Check/data/cache
      echo "ðŸ“ DiretÃ³rios criados com sucesso"
  - name: Executar OWASP Dependency-Check
    id: scan
    shell: bash
    run: |
      echo "ðŸ” Iniciando Dependency-Check para: ${{ inputs.project-name }}"
      echo "ðŸ“‚ Scan path: ${{ inputs.scan-path }}"
      echo "ðŸ—‚ï¸ DiretÃ³rio atual: $(pwd)"
      echo "ðŸ“‹ Arquivos no diretÃ³rio:"
      ls -la ${{ inputs.scan-path }}

      docker run --rm \
        -e user=$USER \
        -u $(id -u ${USER}):$(id -g ${USER}) \
        --volume $(pwd)/${{ inputs.scan-path }}:/src:z \
        --volume $HOME/OWASP-Dependency-Check/data:/usr/share/dependency-check/data:z \
        --volume $(pwd)/.odc-reports:/report:z \
        owasp/dependency-check:latest \
        --nvdApiKey "${{ inputs.nvd-api-key }}" \
        --scan /src \
        -f HTML \
        -f JSON \
        -f XML \
        --project "${{ inputs.project-name }}" \
        --out /report \
        --log /report/dependency-check.log \
        -v \
        || SCAN_FAILED=true

      echo ""
      echo "ðŸ“Š RelatÃ³rios gerados:"
      ls -lah .odc-reports/ || echo "âš ï¸ Nenhum relatÃ³rio encontrado"

      echo "report-path=.odc-reports" >> $GITHUB_OUTPUT

      if [ "$SCAN_FAILED" = "true" ] && [ "${{ inputs.fail-on-error }}" = "true" ]; then
        echo "âŒ Dependency-Check encontrou problemas crÃ­ticos"
        exit 1
      fi

      echo "âœ… Dependency-Check concluÃ­do"

  - name: Upload Dependency-Check Reports
    uses: actions/upload-artifact@v4
    if: always()
    with:
      name: dependency-check-reports
      path: .odc-reports/
      retention-days: 30

  - name: Exibir resumo
    shell: bash
    if: always()
    run: |
      echo "### ðŸ“Š Dependency-Check Report" >> $GITHUB_STEP_SUMMARY
      echo "" >> $GITHUB_STEP_SUMMARY
      echo "- **Projeto**: ${{ inputs.project-name }}" >> $GITHUB_STEP_SUMMARY
      echo "- **RelatÃ³rios**: DisponÃ­veis nos artifacts" >> $GITHUB_STEP_SUMMARY

      if [ -f ".odc-reports/dependency-check-report.json" ]; then
        TOTAL_DEPS=$(jq '.dependencies | length' .odc-reports/dependency-check-report.json 2>/dev/null || echo "N/A")
        echo "- **Total de DependÃªncias**: $TOTAL_DEPS" >> $GITHUB_STEP_SUMMARY
      fi
